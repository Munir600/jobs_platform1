<div class="job-form-edit-container">
  <!-- Header -->
  <div class="page-header">
    <h1 class="page-title">
      {{ isEditMode ? 'تعديل النموذج' : 'إنشاء نموذج جديد' }}
    </h1>
    <p-button
      label="إلغاء"
      styleClass="p-button-secondary"
      (onClick)="cancel()"
    ></p-button>
  </div>

  <!-- Loading Skeleton -->
  @if (loading) {
  <div class="skeleton-form">
    <p-skeleton width="100%" height="3rem" styleClass="mb-3"></p-skeleton>
    <p-skeleton width="100%" height="10rem" styleClass="mb-3"></p-skeleton>
    <p-skeleton width="100%" height="3rem" styleClass="mb-3"></p-skeleton>
  </div>
  }

  <!-- Form -->
  @if (!loading) {
  <form (ngSubmit)="onSubmit()" class="job-form-edit-form">
    <!-- Basic Information -->
    <div class="form-section">
      <h2 class="section-title">المعلومات الأساسية</h2>

      <div class="form-group">
        <label for="name" class="form-label required">
          اسم النموذج
        </label>
        <input
          pInputText
          type="text"
          id="name"
          name="name"
          [(ngModel)]="formData.name"
          required
          maxlength="200"
          placeholder="مثال: نموذج التقديم للمطورين"
          class="form-control"
        />
        <small class="form-hint">حد أقصى 200 حرف</small>
      </div>

      <div class="form-group">
        <label for="description" class="form-label">
          وصف النموذج
        </label>
        <textarea
          pTextarea
          id="description"
          name="description"
          [(ngModel)]="formData.description"
          rows="4"
          placeholder="وصف مختصر عن النموذج..."
          class="form-control"
        ></textarea>
      </div>

      <div class="form-group">
        <div class="checkbox-group">
          <p-checkbox
            [(ngModel)]="formData.is_active"
            [binary]="true"
            inputId="is_active"
            name="is_active"
          ></p-checkbox>
          <label for="is_active" class="checkbox-label">
            النموذج نشط
          </label>
        </div>
        <small class="form-hint">النماذج النشطة فقط ستظهر للمتقدمين</small>
      </div>
    </div>

    <!-- Questions Section -->
    <div class="form-section">
      <div class="section-header">
        <h2 class="section-title">الأسئلة</h2>
        <p-button
          type="button"
          label="إضافة سؤال"
          icon="pi pi-plus"
          styleClass="p-button-sm p-button-primary"
          (onClick)="addQuestion()"
        ></p-button>
      </div>

      @if (questions.length === 0) {
      <div class="empty-questions">
        <p>لا توجد أسئلة. انقر على "إضافة سؤال" لبدء إضافة الأسئلة.</p>
      </div>
      }

      @for (question of questions; track questionIndex; let questionIndex = $index) {
      <div class="question-card">
        <div class="question-header">
          <span class="question-number">سؤال {{ questionIndex + 1 }}</span>
          <div class="question-actions">
        <button
          type="button"
          class="action-icon-btn"
          (click)="moveQuestionUp(questionIndex)"
          [disabled]="questionIndex === 0"
          title="نقل لأعلى"
        >
          <i class="pi pi-arrow-up"></i>
        </button>
        <button
          type="button"
          class="action-icon-btn"
          (click)="moveQuestionDown(questionIndex)"
          [disabled]="questionIndex === questions.length - 1"
          title="نقل لأسفل"
        >
          <i class="pi pi-arrow-down"></i>
        </button>
        <button
          type="button"
          class="action-icon-btn delete-btn"
          (click)="removeQuestion(questionIndex)"
          title="حذف"
        >
          <i class="pi pi-trash"></i>
        </button>
          </div>
        </div>

        <div class="question-body">
          <div class="form-row">
            <div class="form-group full-width">
              <label [for]="'label_' + questionIndex" class="form-label required">
                نص السؤال
              </label>
              <input
                pInputText
                type="text"
                [id]="'label_' + questionIndex"
                [name]="'label_' + questionIndex"
                [(ngModel)]="question.label"
                required
                placeholder="مثال: ما هي خبرتك في البرمجة؟"
                class="form-control"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label [for]="'question_type_' + questionIndex" class="form-label required">
                نوع السؤال
              </label>
              <p-select
                [id]="'question_type_' + questionIndex"
                [name]="'question_type_' + questionIndex"
                [(ngModel)]="question.question_type"
                [options]="questionTypes"
                optionLabel="label"
                optionValue="value"
                placeholder="اختر نوع السؤال"
                styleClass="w-full"
                (ngModelChange)="onQuestionTypeChange(questionIndex)"
              ></p-select>
            </div>

            <div class="form-group">
              <div class="checkbox-group">
                <p-checkbox
                  [(ngModel)]="question.required"
                  [binary]="true"
                  [inputId]="'required_' + questionIndex"
                  [name]="'required_' + questionIndex"
                ></p-checkbox>
                <label [for]="'required_' + questionIndex" class="checkbox-label">
                  إجباري
                </label>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label [for]="'help_text_' + questionIndex" class="form-label">
              نص مساعد (اختياري)
            </label>
            <input
              pInputText
              type="text"
              [id]="'help_text_' + questionIndex"
              [name]="'help_text_' + questionIndex"
              [(ngModel)]="question.help_text"
              placeholder="نص توضيحي للمساعدة في الإجابة"
              class="form-control"
            />
          </div>

          @if (needsOptions(question.question_type)) {
          <div class="form-group">
            <div class="options-header">
              <label class="form-label required">الخيارات</label>
              <p-button
                type="button"
                label="إضافة خيار"
                icon="pi pi-plus"
                styleClass="p-button-sm p-button-primary"
                (onClick)="addOption(questionIndex)"
              ></p-button>
            </div>
            
            @if (!question.optionsArray || question.optionsArray.length === 0) {
            <div class="empty-options">
              <p>لا توجد خيارات. انقر على "إضافة خيار" لإضافة خيارات.</p>
            </div>
            }
            
            @if (question.optionsArray && question.optionsArray.length > 0) {
            <div class="options-list">
              @for (option of question.optionsArray; track $index) {
              <div class="option-item">
                <label [for]="'option_' + questionIndex + '_' + $index" class="sr-only">
                  {{ 'خيار ' + ($index + 1) }}
                </label>
                <input
                  pInputText
                  type="text"
                  [id]="'option_' + questionIndex + '_' + $index"
                  [name]="'option_' + questionIndex + '_' + $index"
                  [(ngModel)]="question.optionsArray[$index]"
                  [placeholder]="'خيار ' + ($index + 1)"
                  class="form-control option-input"
                />
                <button
                  type="button"
                  class="action-icon-btn delete-btn"
                  (click)="removeOption(questionIndex, $index)"
                  title="حذف الخيار"
                >
                  <i class="pi pi-trash"></i>
                </button>
              </div>
              }
            </div>
            }
          </div>
          }
        </div>
      </div>
      }
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <p-button
        type="button"
        label="إلغاء"
        styleClass="p-button-secondary"
        (onClick)="cancel()"
        [disabled]="saving"
      ></p-button>
      <p-button
        type="submit"
        [label]="saving ? 'جاري الحفظ...' : (isEditMode ? 'تحديث' : 'إنشاء')"
        styleClass="p-button-primary"
        [disabled]="saving"
        [loading]="saving"
      ></p-button>
    </div>
  </form>
  }
</div>

